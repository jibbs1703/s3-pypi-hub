name: Publish to GitHub Releases

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create initial tag v0.0.0 if missing
        run: |
          if ! git tag -l | grep -q "^v0.0.0$"; then
            echo "No tags found â†’ creating v0.0.0"
            git tag v0.0.0
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      
      - name: Derive version & release type
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            echo "release_type=stable" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "release_type=dev" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build setuptools setuptools_scm[toml] twine

      - name: Build package
        run: python -m build testpackage

      - name: Verify built packages
        run: |
          ls -la testpackage/dist/
          twine check testpackage/dist/*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          name: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || format('dev-{0}', github.sha) }}
          tag_name: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || format('dev-{0}', github.sha) }}